---
title: "Solar Elevation Across Europe"
editor_options: 
  chunk_output_type: inline
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

This demonstrates the `solarpos` geographic sweep and time series features.

## Data Generation

Generate solar elevation data across Europe using coordinate ranges:

```{r generate-data}
library(tidyverse)
library(lubridate)

# Generate European solar elevation data using solarpos geographic sweep
system(
  "solarpos --format=csv --headers 32.0:73.0:0.5 -13.0:43.0:0.5 2027-06-21T12:00Z position > /tmp/europe_dense.csv"
)

solar_data <- read_csv("/tmp/europe_dense.csv", show_col_types = FALSE) |>
  mutate(elevation = 90 - zenith)

cat("Dataset:", nrow(solar_data), "points\n")
cat("Elevation range:", round(min(solar_data$elevation), 1), "to", round(max(solar_data$elevation), 1), "degrees\n")
```

## Visualization

Create a filled contour map showing solar elevation gradients:

```{r solar-map, fig.width=12, fig.height=8}
solar_map <- ggplot(solar_data, aes(x = longitude, y = latitude)) +
  borders(
    "world",
    colour = "white",
    fill = "grey20",
    size = 0.3,
    alpha = 0.8
  ) +
  geom_contour_filled(aes(z = elevation), alpha = 0.85, bins = 20) +
  scale_fill_viridis_d(option = "plasma") +
  guides(fill = "none") +
  coord_quickmap(xlim = c(-10, 40), ylim = c(35, 70)) +
  labs(
    title = "Solar Elevation",
    subtitle = "Summer Solstice 2027, GMT noon",
    x = "Longitude",
    y = "Latitude",
    caption = "Generated with solarpos geographic sweep."
  )

solar_map
```

This shows how solar elevation varies across Europe at GMT/UTC noon on the summer solstice, with higher elevations (brighter colors) in southern regions and lower elevations (darker colors) in northern regions.

## Time Series 

Now let's see how this solar elevation pattern changes throughout the day by asking `solarpos` for a combined coordinate sweep and time series in one call. Use the Grena3 algorithm to potentially save a little time.

```{r generate-time-series}
result <- system(
  "solarpos --format=csv --headers 32.0:73.0:2.0 -13.0:43.0:2.0 2027-06-21 --timezone=UTC position --step=3600 --algorithm=GRENA3 > /tmp/europe_time_series.csv"
)

raw_data <- read_csv("/tmp/europe_time_series.csv", show_col_types = FALSE)
time_data <- raw_data |>
  mutate(
    elevation = 90 - zenith,
    datetime_parsed = as.POSIXct(dateTime),
    hour = hour(datetime_parsed)
  )

cat("Unique hours in data:", sort(unique(time_data$hour)), "\n")

time_data <- time_data |>
  filter(hour >= 6, hour <= 18, !is.na(elevation)) %>%
  arrange(hour, latitude, longitude)

time_data
```

```{r faceted-time-series, fig.width=16, fig.height=12}
# Create faceted plot showing solar elevation throughout the day
selected_hours <- c(8, 10, 12, 14, 16, 18)
facet_data <- time_data |> 
  filter(hour %in% selected_hours) |>
  mutate(hour_label = paste0(sprintf("%02d", hour), ":00 UTC"))

time_series_plot <- ggplot(facet_data, aes(x = longitude, y = latitude)) +
  borders(
    "world",
    colour = "white",
    fill = "grey20",
    size = 0.3,
    alpha = 0.8
  ) +
  geom_contour_filled(aes(z = elevation), alpha = 0.85, bins = 20) +
  scale_fill_viridis_d(option = "plasma") +
  guides(fill = "none") +
  coord_quickmap(xlim = c(-10, 40), ylim = c(35, 70)) +
  facet_wrap(~hour_label, ncol = 3) +
  labs(
    title = "Solar Elevation Throughout the Day",
    subtitle = "Summer Solstice 2027",
    x = "Longitude",
    y = "Latitude",
    caption = "Generated with solarpos time series and geographic sweep."
  ) +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )

time_series_plot
```

These time series snapshots show the "solar elevation wave" moving across Europe throughout the day.
